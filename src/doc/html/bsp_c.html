<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RKH: &quot;bsp.c&quot;</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">RKH
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_usage.html">Representing a state machine: step by step</a>      </li>
      <li class="navelem"><a class="el" href="identify_events.html">Identifying, generating and sending events</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">"bsp.c" </div>  </div>
</div>
<div class="contents">
<div class="textblock"><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment">    file: bsp.c</span>
<span class="comment">    Last updated for version: 2.0</span>
<span class="comment">    Date of the last update:  Feb 28, 2012</span>
<span class="comment"></span>
<span class="comment">    Copyright (C) 2010 Leandro Francucci. All rights reserved.</span>
<span class="comment"></span>
<span class="comment">    RKH is free software: you can redistribute it and/or modify</span>
<span class="comment">    it under the terms of the GNU General Public License as published by</span>
<span class="comment">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="comment">    (at your option) any later version.</span>
<span class="comment"></span>
<span class="comment">  RKH is distributed in the hope that it will be useful,</span>
<span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">  GNU General Public License for more details.</span>
<span class="comment"></span>
<span class="comment">  You should have received a copy of the GNU General Public License</span>
<span class="comment">  along with RKH, see copying.txt file.</span>
<span class="comment"></span>
<span class="comment"> Contact information:</span>
<span class="comment"> RKH web site:  http://</span>
<span class="comment"> e-mail:            francuccilea@gmail.com</span>
<span class="comment"> */</span>


<span class="preprocessor">#include &quot;bsp.h&quot;</span>
<span class="preprocessor">#include &quot;my.h&quot;</span>
<span class="preprocessor">#include &quot;rkhdata.h&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="rkh_8h.html" title="RKH platform-independent interface.">rkh.h</a>&quot;</span>
<span class="preprocessor">#include &quot;trazer.h&quot;</span>

<span class="preprocessor">#include &lt;conio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;time.h&gt;</span>


<span class="preprocessor">#define BIN_TRACE                   1</span>
<span class="preprocessor"></span><span class="preprocessor">#define ESC                         0x1B</span>
<span class="preprocessor"></span><span class="preprocessor">#define kbmap( c )                  ( c - &#39;0&#39; )</span>
<span class="preprocessor"></span>

<a class="code" href="rkhassert_8h.html#a57dfc35a74e5e399f3c6c5f0bad6e6ba" title="This macro appears at the top of each C/C++ source file defining a name for that file, by means of __FILE__ compiler directive.">RKH_THIS_MODULE</a>

<span class="keyword">static</span> <span class="keywordtype">char</span> fmt[ 64 ];
FILE *fdbg;
<span class="preprocessor">#if BIN_TRACE == 1</span>
<span class="preprocessor"></span><span class="keyword">static</span> FILE *ftbin;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="keyword">static</span> DWORD tick_msec;         <span class="comment">/* clock tick in msec */</span>
rkhui8_t running;
MYEVT_T *mye;
<span class="keyword">static</span> <a class="code" href="rkh_8h.html#ac2d1fc13a6b019e7967db720d72dfcd8" title="This macro declares and initializes the event structure e with es signal and establishes it as one st...">RKH_DCLR_STATIC_EVENT</a>( eterm, TERM );

<span class="keyword">static</span> 
DWORD WINAPI 
isr_tmr_thread( LPVOID par )    <span class="comment">/* Win32 thread to emulate timer ISR */</span>
{
    ( void )par;
    <span class="keywordflow">while</span>( running ) 
    {
        <a class="code" href="rkh_8h.html#a7db674272d1231053666dcc21f5fbaba" title="Keep tracks and updates the started timers.">rkh_tim_tick</a>();
        Sleep( tick_msec );
    }
    <span class="keywordflow">return</span> 0;
}


<span class="keyword">static</span> 
DWORD WINAPI 
isr_kbd_thread( LPVOID par )            <span class="comment">/* Win32 thread to emulate keyboard ISR */</span>
{
    <span class="keywordtype">int</span> c;
    MYEVT_T *mye;

    ( void )par;
    <span class="keywordflow">while</span>( running ) 
    {
        c = _getch();
        
        <span class="keywordflow">if</span>( c == ESC )
            <a class="code" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo</a>( my, &amp;eterm );
        <span class="keywordflow">else</span>
        {
            mye = <a class="code" href="rkh_8h.html#a66808180348a0a822a0fa46328b7f7d9" title="This macro dynamically creates a new event of type et with its signal.">RKH_ALLOC_EVENT</a>( MYEVT_T, kbmap( c ) );
            mye-&gt;ts = ( rkhui16_t )rand();
            <a class="code" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo</a>( my, ( <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a>* )mye );
        }
    }
    <span class="keywordflow">return</span> 0;
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a8e824db08ba7430b74762a487804812b" title="This hook function is called just before the RKH takes over control of the application.">rkh_hk_start</a>( <span class="keywordtype">void</span> ) 
{
    DWORD thtmr_id, thkbd_id;
    HANDLE hth_tmr, hth_kbd;

    <span class="comment">/* set the desired tick rate */</span>
    tick_msec = 1000UL/BSP_TICKS_PER_SEC;
    running = (rkhui8_t)1;
    
    <span class="comment">/* create the ISR timer thread */</span>
    hth_tmr = CreateThread( NULL, 1024, &amp;isr_tmr_thread, 0, 0, &amp;thtmr_id );
    <a class="code" href="rkhassert_8h.html#a44e0d6b7a49a3b03d45b88111391031d" title="The RKHASSERT() macro is used to check expressions that ought to be true as long as the program is ru...">RKHASSERT</a>( hth_tmr != (HANDLE)0 );
    SetThreadPriority( hth_tmr, THREAD_PRIORITY_TIME_CRITICAL );

    <span class="comment">/* create the ISR keyboard thread */</span>
    hth_kbd = CreateThread( NULL, 1024, &amp;isr_kbd_thread, 0, 0, &amp;thkbd_id );
    <a class="code" href="rkhassert_8h.html#a44e0d6b7a49a3b03d45b88111391031d" title="The RKHASSERT() macro is used to check expressions that ought to be true as long as the program is ru...">RKHASSERT</a>( hth_kbd != (HANDLE)0 );
    SetThreadPriority( hth_kbd, THREAD_PRIORITY_NORMAL );
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit</a>( <span class="keywordtype">void</span> ) 
{
    <a class="code" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush</a>();
    running = 0;
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle</a>( <span class="keywordtype">void</span> )             <span class="comment">/* called within critical section */</span>
{
    <a class="code" href="rkhitl_8h.html#a42bd908ca2b52b24bb823187ba800076" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_EXIT_CRITICAL</a>( dummy );
    <a class="code" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush</a>();
    RKH_WAIT_FOR_EVENTS();      <span class="comment">/* yield the CPU until new event(s) arrive */</span>
}


<span class="keywordtype">void</span> 
<a class="code" href="rkhassert_8h.html#ad3c2370571718a2d3fc76b9bf9850cd5" title="Callback invoked in case the condition passed to RKHASSERT(), RKHREQUIRE(), RKHENSURE(), RKHERROR(), or RKHALLEGE() evaluates to FALSE.">rkh_assert</a>( RKHROM <span class="keywordtype">char</span> * <span class="keyword">const</span> file, <span class="keywordtype">int</span> line )
{
    fprintf( stderr,    <span class="stringliteral">&quot;RKHASSERT: [%d] line from %s &quot;</span>
                        <span class="stringliteral">&quot;file\n&quot;</span>, line, file );
    __debugbreak();
    <a class="code" href="rkh_8h.html#ab18447f196fdd82c3d46617dff71a44c" title="Exit the RKH framework.">rkh_exit</a>();
}


<span class="keyword">static</span>
<span class="keywordtype">void</span>
print_banner( <span class="keywordtype">void</span> )
{
    printf( <span class="stringliteral">&quot;Abstract Hierarchical State Machine (AHSM) example\n\n&quot;</span> );
    printf( <span class="stringliteral">&quot;RKH version      = %s\n&quot;</span>, <a class="code" href="rkhitl_8h.html#af68b848acd1eefad3e96392c33a3e821" title="This macro retrieves a pointer to string describing the RKH version. For example, &quot;2...">RKH_RELEASE</a> );
    printf( <span class="stringliteral">&quot;Port version     = %s\n&quot;</span>, rkh_get_port_version() );
    printf( <span class="stringliteral">&quot;Port description = %s\n\n&quot;</span>, rkh_get_port_desc() );
    printf( <span class="stringliteral">&quot;Description: \n\n&quot;</span>
            <span class="stringliteral">&quot;The goal of this demo application is to explain how to \n&quot;</span>
            <span class="stringliteral">&quot;represent a state machine using the RKH framework. To do \n&quot;</span>
            <span class="stringliteral">&quot;that is proposed a simple and abstract example, which is \n&quot;</span>
            <span class="stringliteral">&quot;shown in the documentation file Figure 1 section \n&quot;</span>
            <span class="stringliteral">&quot;\&quot;Representing a State Machine\&quot;. \n\n\n&quot;</span> );

    printf( <span class="stringliteral">&quot;1.- Press &lt;numbers&gt; to send events to state machine. \n&quot;</span> );
    printf( <span class="stringliteral">&quot;2.- Press ESC to quit \n\n\n&quot;</span> );
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a01e6ed5f8d81d1e3ec5bf32d44a4bab6" title="Open the tracing session.">rkh_trc_open</a>( <span class="keywordtype">void</span> )
{
    <a class="code" href="rkhtrc_8h.html#a8b7d1e9c3b57e75d0b5289282afdd10e" title="Initializes the RKH&#39;s trace record service.">rkh_trc_init</a>();
    <a class="code" href="rkhtrc_8h.html#a88a14ad1c20c7ebcd54c30a1265a056e" title="Starts or stops the tracing session.">rkh_trc_control</a>( RKH_TRC_START );

    <span class="keywordflow">if</span>( ( fdbg = fopen( <span class="stringliteral">&quot;../ahlog.txt&quot;</span>, <span class="stringliteral">&quot;w+&quot;</span> ) ) == NULL )
    {
        perror( <span class="stringliteral">&quot;Can&#39;t open file\n&quot;</span> );
        exit( EXIT_FAILURE );
    }

<span class="preprocessor">#if BIN_TRACE == 1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span>( ( ftbin = fopen( <span class="stringliteral">&quot;../ftbin&quot;</span>, <span class="stringliteral">&quot;w+b&quot;</span> ) ) == NULL )
    {
        perror( <span class="stringliteral">&quot;Can&#39;t open file\n&quot;</span> );
        exit( EXIT_FAILURE );
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    trazer_init();
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a82ea03425018b8a70571b3499b70e8d3" title="Close the tracing session.">rkh_trc_close</a>( <span class="keywordtype">void</span> )
{
    fclose( fdbg );
<span class="preprocessor">#if BIN_TRACE == 1</span>
<span class="preprocessor"></span>    fclose( ftbin );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}


<span class="preprocessor">#if BIN_TRACE == 1</span>
<span class="preprocessor"></span><span class="preprocessor">    #define ftbin_flush( d )                \</span>
<span class="preprocessor">                fwrite ( d, 1, 1, ftbin );  \</span>
<span class="preprocessor">                fflush( ftbin )</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">    #define ftbin_flush()</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<a class="code" href="rkhtrc_8h.html#a35f6c91d6f5a83e634f757e867290186" title="Defines the size of trace timestamp.">RKHTS_T</a> 
<a class="code" href="rkh_8h.html#ac289dc76e3dc4fdc23691782caa3aab9" title="Retrieves a timestamp to be placed in a trace event.">rkh_trc_getts</a>( <span class="keywordtype">void</span> )
{
    <span class="keywordflow">return</span> ( <a class="code" href="rkhtrc_8h.html#a35f6c91d6f5a83e634f757e867290186" title="Defines the size of trace timestamp.">RKHTS_T</a> )clock();
}


<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush</a>( <span class="keywordtype">void</span> )
{
    rkhui8_t *d;

    <span class="keywordflow">while</span>( ( d = <a class="code" href="rkhtrc_8h.html#a010da69e7e79a10723f60d37e60be609" title="Retrieves a pointer to oldest stored byte in the trace stream. Frequently, this function is used by t...">rkh_trc_get</a>() ) != ( rkhui8_t* )0 )
    {
        ftbin_flush( d );
        trazer_parse( *d );
    }
}


<span class="keywordtype">void</span> 
bsp_init( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[] )
{
    (void)argc;
    (void)argv;

    srand( ( <span class="keywordtype">unsigned</span> )time( NULL ) );
    print_banner();
}
</pre></div> </div></div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 9 2012 13:05:36 for RKH by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
