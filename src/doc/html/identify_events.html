<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RKH: Identifying, generating and sending events</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">RKH
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_usage.html">Representing a state machine: step by step</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Identifying, generating and sending events </div>  </div>
</div>
<div class="contents">
<div class="textblock"><div class="image">
<img src="rkh_bunner.jpg" alt="rkh_bunner.jpg"/>
</div>
<p><br/>
 Prev: <a class="el" href="preparing.html">Preparing the application files</a><br/>
 Next: <a class="el" href="identify.html">Identifying and classifying states and pseudostates</a><br/>
</p>
<p>The events in the <code>my</code> state machine have been identified in the state diagram in <a class="el" href="_usage.html#fig1">Figure 1</a>. Note that events consist really of two parts. The part of the event called the signal conveys the type of the occurrence (what happened). For example, the ONE signal conveys the arrival of a press key '1'. An event can also contain additional quantitative information about the occurrence in form of event parameters. In <code>my</code> state machine, all signals are accompanied by the parameter (ts) that contain the quantitative information as to timestamp. In RKH, events are represented as instances of the <a class="el" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> structure provided by the framework. Specifically, the <a class="el" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> structure contains the member <code>e</code>, to represent the signal of that event. Event parameters are added in the process of <a class="el" href="struct_r_k_h_e_v_t___t.html">inheritance </a>.</p>
<ul>
<li><a class="el" href="identify_events.html#ide_e">Identifying events</a></li>
<li><a class="el" href="identify_events.html#gen_e">Generating and posting events</a></li>
</ul>
<hr/>
 <h2><a class="anchor" id="ide_e"></a>
Identifying events</h2>
<p>Because events are explicitly shared among most of the application components, it is convenient to declare them in the separate header file <a class="el" href="my_h.html">"my.h"</a>, which is shown below.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment">    my.h</span>
<span class="comment"> */</span>


<span class="preprocessor">#ifndef __MY_H__</span>
<span class="preprocessor"></span><span class="preprocessor">#define __MY_H__</span>
<span class="preprocessor"></span>

<span class="preprocessor">#include &quot;<a class="code" href="rkh_8h.html" title="RKH platform-independent interface.">rkh.h</a>&quot;</span>


<span class="comment">/*</span>
<span class="comment">    Signals</span>
<span class="comment"> */</span>

<span class="keyword">enum</span>
{
    ZERO,       <span class="comment">/* press the key &#39;0&#39; on the keyboard */</span>
    ONE,        <span class="comment">/* press the key &#39;1&#39; on the keyboard */</span>
    TWO,        <span class="comment">/* press the key &#39;2&#39; on the keyboard */</span>
    THREE,      <span class="comment">/* press the key &#39;3&#39; on the keyboard */</span>
    FOUR,       <span class="comment">/* press the key &#39;4&#39; on the keyboard */</span>
    FIVE,       <span class="comment">/* press the key &#39;5&#39; on the keyboard */</span>
    SIX,        <span class="comment">/* press the key &#39;6&#39; on the keyboard */</span>
    TERM        <span class="comment">/* press the key escape on the keyboard */</span>
};


<span class="keyword">typedef</span> <span class="keyword">struct</span>
{
    <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> event;
    rkhui16_t ts;
} MYEVT_T;

...

#endif
</pre></div><hr/>
 <h2><a class="anchor" id="gen_e"></a>
Generating and posting events</h2>
<p>RKH supports the simple mechanism of direct event posting supported through the functions <a class="el" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo()</a> and <a class="el" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo()</a>, where the producer of an event directly posts the event to the event queue of the consumer active object (SMA). In RKH, any part of the system can produce events, not necessarily only the SMAs. For example, interrupt service routines (ISRs) or device drivers can also produce events. On the other hand, only SMAs can consume events, because only SMAs have event queues. The following listing provides examples of posting dynamic and static events from the interrupt service routines (ISRs) of the <code>ahsm</code> demo application version for the win32 single thread, <a class="el" href="bsp_c.html">"bsp.c"</a> file.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #define ESC             0x1B</span>
<span class="preprocessor"></span><span class="preprocessor">    #define kbmap( c )      ( (c) - &#39;0&#39; )</span>
<span class="preprocessor"></span>
(1) <span class="keyword">static</span> <a class="code" href="rkh_8h.html#ac2d1fc13a6b019e7967db720d72dfcd8" title="This macro declares and initializes the event structure e with es signal and establishes it as one st...">RKH_DCLR_STATIC_EVENT</a>( eterm, TERM );

    ...

    <span class="keyword">static</span> 
    DWORD WINAPI 
(2) isr_kbd_thread( LPVOID par )    <span class="comment">/* Win32 thread to emulate keyboard ISR */</span>
    {
        <span class="keywordtype">int</span> c;
        MYEVT_T *mye;

        ( void )par;
        <span class="keywordflow">while</span>( running ) 
        {
            c = _getch();
            
            <span class="keywordflow">if</span>( c == ESC )
(3)             <a class="code" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo</a>( my, &amp;eterm );
            <span class="keywordflow">else</span>
            {
(4)             mye = <a class="code" href="rkh_8h.html#a66808180348a0a822a0fa46328b7f7d9" title="This macro dynamically creates a new event of type et with its signal.">RKH_ALLOC_EVENT</a>( MYEVT_T, kbmap( c ) );
(5)             mye-&gt;ts = ( rkhui16_t )rand();
(6)             <a class="code" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo</a>( my, ( <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a>* )mye );
            }
        }
        <span class="keywordflow">return</span> 0;
    }
</pre></div><ul>
<li>(1) The TERM event never changes, so it can be statically allocated just once. The <a class="el" href="rkh_8h.html#ac2d1fc13a6b019e7967db720d72dfcd8" title="This macro declares and initializes the event structure e with es signal and establishes it as one st...">RKH_DCLR_STATIC_EVENT()</a> macro declares and initializes the event structure <em>eterm</em> with <em>TERM</em> signal and establishes it as one static event. The created event object is explicitly placed in ROM. </li>
<li>(2) Win32 thread to emulate keyboard ISR. </li>
<li>(3) The static event is posted directly to the <code>my</code> SMA. </li>
<li>(4) The macro <a class="el" href="rkh_8h.html#a66808180348a0a822a0fa46328b7f7d9" title="This macro dynamically creates a new event of type et with its signal.">RKH_ALLOC_EVENT()</a> dinamically allocates an instance of MYEVT_T event from an event pool. The macro also performs the association between the signal and the allocated event. The signals are generated from the key strokes by means of <code>kbmap()</code> macro. </li>
<li>(5) The <code>ts</code> parameter of the event is assigned. </li>
<li>(6) The dynamic event is posted directly to the <code>my</code> SMA..</li>
</ul>
<p><br/>
 Prev: <a class="el" href="preparing.html">Preparing the application files</a><br/>
 Next: <a class="el" href="identify.html">Identifying and classifying states and pseudostates</a><br/>
 </p>
</div></div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 9 2012 13:05:36 for RKH by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
