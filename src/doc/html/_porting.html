<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RKH: Porting</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">RKH
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Porting </div>  </div>
</div>
<div class="contents">
<div class="textblock"><div class="image">
<img src="rkh_bunner.jpg" alt="rkh_bunner.jpg"/>
</div>
<p>Prev: <a class="el" href="index.html#main_page">Home</a> <br/>
 Next: <a class="el" href="cfg.html">Configuration</a></p>
<p>This section describes how to adapt the RKH to various platforms, which is a process called porting. RKH contains a clearly defined abstraction layer, which encapsulates all the platform-specific code and cleanly separates it from platform-neutral code.</p>
<p>Porting RKH implies to create the a few platform-dependent files, <b>rhhport.h</b>, <b>rkhport.c</b>, which frequently defines the interrupt locking method, the critical section management, among other things. The RKH directories and files are described in detail in <a class="el" href="_installation.html">Installation</a> section. The next sections listed below describes the aspects to be considered to port RKH:</p>
<p><br/>
 This section includes:</p>
<ul>
<li><a class="el" href="_porting.html#files">Platform-dependent files</a></li>
<li><a class="el" href="_porting.html#data">Data types definitions</a></li>
<li><a class="el" href="_porting.html#rom">ROM allocator</a></li>
<li><a class="el" href="_porting.html#blk">Blocking mechanism</a></li>
<li><a class="el" href="_porting.html#prio">Priority mechanism</a></li>
<li><a class="el" href="_porting.html#eque">Event queue</a></li>
<li><a class="el" href="_porting.html#dyn">Dynamic event support</a></li>
<li><a class="el" href="_porting.html#hk">Hook functions</a></li>
<li><a class="el" href="_porting.html#ilock">Interrupt locking mechanism</a></li>
<li><a class="el" href="_porting.html#crt">Critical section</a></li>
<li><a class="el" href="_porting.html#trc">Trace facility</a></li>
<li><a class="el" href="_porting.html#rkhp">A port file example.</a></li>
</ul>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="files"></a>
Platform-dependent files</h2>
<p>All software components of the RKH, contain a platform abstraction layer. It is an indirection layer that hides the differences in hardware and software environments in which RKH operates so that the RKH source code does not need to be changed to run in a different environment. Instead, all the changes required to adapt RKH are confined to this layer. It's basically composed by a few files, <b><a class="el" href="rkhplat_8h.html" title="RKH platform-dependent interface.">rkhplat.h</a></b> and <a class="el" href="rkhtype_8h.html" title="This file defines the data types that uses RKH.">rkhtype.h</a>, which include references to the actual platform-dependent files like <b>rkhport.h</b> and <b>rkht.h</b>. The platform-specific code for the RKH port is defined by <b>rkhport.c</b>. Not all RKH ports require this file.</p>
<p>As said above, each platform, compiler or processor supported by RKH must have its own platform-dependent file, called <b>rkhport.h</b> by RKH convention. Next, each <b>rkhport.h</b> file must be referenced from <a class="el" href="rkhplat_8h.html" title="RKH platform-dependent interface.">rkhplat.h</a> header file, located in \include directory. The next listing shows an example of <b><a class="el" href="rkhplat_8h.html" title="RKH platform-dependent interface.">rkhplat.h</a></b>, where __CFV1CW63__, and __W32STVC08__ are used to instruct the C/C++ compiler to include header files from the specific RKH port directory. The key point of the design is that all platform-independent RKH source files include the same <b><a class="el" href="rkhplat_8h.html" title="RKH platform-dependent interface.">rkhplat.h</a></b> header file as the application source files.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #ifdef __CFV1CW63__</span>
<span class="preprocessor"></span><span class="preprocessor">        #include &quot;..\portable\cfv1\rkhs\cw6_3\rkhport.h&quot;</span>
<span class="preprocessor">    #endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">    #ifdef __W32STVC08__</span>
<span class="preprocessor"></span><span class="preprocessor">        #include &quot;..\portable\80x86\win32_st\vc08\rkhport.h&quot;</span>
<span class="preprocessor">    #endif</span>
<span class="preprocessor">    ...</span>
</pre></div><p>The idea behind conditional compilation is that a <b>rkhport.h</b> can be selectively compiled, depending upon whether a specific value has been defined.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The path of platform-dependent file must be relative. </dd></dl>
 Please, see <a class="el" href="_installation.html#portable_dir">RKH portable directory</a> section.</p>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="data"></a>
Data types definitions</h2>
<p>The RKH uses a set of integer quantities. That maybe machine or compiler dependent. These types must be defined in <b>rkht.h</b> file. The following listing shows the required data type definitions:</p>
<div class="fragment"><pre class="fragment">  <span class="comment">// Denotes a signed integer type with a width of exactly 8 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">char</span>   rkhi8_t;

  <span class="comment">// Denotes a signed integer type with a width of exactly 16 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">short</span>  rkhi16_t;

  <span class="comment">// Denotes a signed integer type with a width of exactly 32 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">long</span>       rkhi32_t;

  <span class="comment">// Denotes an unsigned integer type with a width of exactly 8 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>     rkhui8_t;

  <span class="comment">// Denotes an unsigned integer type with a width of exactly 16 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    rkhui16_t;

  <span class="comment">// Denotes an unsigned integer type with a width of exactly 32 bits</span>
  <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rkhui32_t;

  <span class="comment">// Denotes an unsigned integer type that is usually fastest to operate with </span>
  <span class="comment">// among all integer types.</span>
  <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  HUInt;

  <span class="comment">// Denotes a signed integer type that is usually fastest to operate with </span>
  <span class="comment">// among all integer types.</span>
  <span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">int</span>        HInt;
</pre></div><p>Next, each <b>rkht.h</b> file must be referenced from <b><a class="el" href="rkhtype_8h.html" title="This file defines the data types that uses RKH.">rkhtype.h</a></b> header file, located in \include directory. The next listing shows an example of <b><a class="el" href="rkhtype_8h.html" title="This file defines the data types that uses RKH.">rkhtype.h</a></b>, where __CFV1CW63__, and __W32STVC08__ are used to instruct the C/C++ compiler to include header files from the specific RKH port directory. The key point of the design is that all platform-independent RKH source files include the same <b><a class="el" href="rkhtype_8h.html" title="This file defines the data types that uses RKH.">rkhtype.h</a></b> header file as the application source files.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #ifdef __CFV1CW63__</span>
<span class="preprocessor"></span><span class="preprocessor">        #include &quot;..\portable\cfv1\rkhs\cw6_3\rkht.h&quot;</span>
<span class="preprocessor">    #endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">    #ifdef __W32STVC08__</span>
<span class="preprocessor"></span><span class="preprocessor">        #include &quot;..\portable\80x86\win32_st\vc08\rkht.h&quot;</span>
<span class="preprocessor">    #endif</span>
<span class="preprocessor">    ...</span>
</pre></div><p>The idea behind conditional compilation is that a <b>rkht.h</b> can be selectively compiled, depending upon whether a specific value has been defined.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The path of platform-dependent file must be relative. </dd></dl>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="rom"></a>
ROM allocator</h2>
<p>For declaring an object that its value will not be changed and that will be stored in ROM, must be defined in <b>rkhport.h</b> the RKHROM macro.</p>
<p>Example:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#define RKHROM          const</span>
</pre></div><p><br/>
 <hr/>
 <h2><a class="anchor" id="blk"></a>
Blocking mechanism</h2>
<p><em>RKH works in conjunction with a traditional OS/RTOS?</em></p>
<p><b>YES:</b> <br/>
 The RKH framework can work with virtually any traditional OS/RTOS. Combined with a conventional RTOS, RKH takes full advantage of the multitasking capabilities of the RTOS by executing each active object (SMA) in a separate task or thread.</p>
<ul>
<li>(1) Define the macros <a class="el" href="rkhcfg_8h.html#a2b05aea5aa72e2666e2d6f9896d663e7">RKH_EN_NATIVE_SCHEDULER</a> = 0, <a class="el" href="rkhcfg_8h.html#aa7b19d3cf6f4f78817416319b154664b">RKH_EN_SMA_THREAD</a> = 1, and <a class="el" href="rkhcfg_8h.html#a0d0ced3d58eddc6c9d49c52ec91d0ae2">RKH_EN_SMA_THREAD_DATA</a>, within the <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> file. </li>
<li>(2) Define the macros <a class="el" href="rkhitl_8h.html#aef5296870b61cf45a868f02602e31340" title="Encapsulates the mechanism of blocking the event queue.">RKH_SMA_BLOCK()</a>, <a class="el" href="rkhitl_8h.html#a6775845b41cbe4a59cc936b0730623a3" title="Encapsulates the mechanism of signaling the thread waiting on the used event queue. Thus, the SMA is inserted in the ready list as ready-to-dispatch.">RKH_SMA_READY()</a>, and <a class="el" href="rkhitl_8h.html#aade2f6ff9a19302e2b61e69b2417fde8" title="Informs the underlying kernel that the SMA event queue is becoming empty. Thus, the SMA is removed fr...">RKH_SMA_UNREADY()</a> in <b>rkhport.h</b> according to underlying OS or RTOS. </li>
<li>(3) Define the macros <a class="el" href="rkhitl_8h.html#a475f9c2c1439b114e4266a642572de15">RKH_OSDATA_TYPE</a>, and <a class="el" href="rkhitl_8h.html#a5a9dfdafe21b301459505206ac572c05">RKH_THREAD_TYPE</a> in <b>rkhport.h</b> according to underlying OS or RTOS. </li>
<li>(4) Then, implement the platform-specific functions <a class="el" href="rkh_8h.html#a348c60d5a5c6b1492ca55648e9aeeaf6" title="Initializes the RKH framework.">rkh_init()</a>, <a class="el" href="rkh_8h.html#a6b8f47b2f288dd0cf2c8b44dd062d509" title="RKH framework is started.">rkh_enter()</a>, <a class="el" href="rkh_8h.html#ab18447f196fdd82c3d46617dff71a44c" title="Exit the RKH framework.">rkh_exit()</a>, <a class="el" href="rkh_8h.html#a02d78c8f4c9f8e2b9fb0cf57711c1220" title="Initializes and activates a previously created state machine application.">rkh_sma_activate()</a>, and <a class="el" href="rkh_8h.html#a4923f3d24f0f3cea38d598f5b7db203c" title="Terminate a state machine application.">rkh_sma_terminate()</a>. All these functions are placed in <b>rkhport.c</b>.</li>
</ul>
<p><em>Example for x86, VC2008, and win32 single thread</em> </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#define RKH_EQ_TYPE                     RKHRQ_T</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_OSDATA_TYPE                 HANDLE</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_THREAD_TYPE                 HANDLE</span>
<span class="preprocessor"></span>

<span class="preprocessor">#define RKH_SMA_BLOCK( sma )                                \</span>
<span class="preprocessor">                RKHASSERT( ((RKHSMA_T*)(sma))-&gt;equeue.qty != 0 )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_SMA_READY( rg, sma )                            \</span>
<span class="preprocessor">                rkh_rdy_ins( (rg), ((RKHSMA_T*)(sma))-&gt;romrkh-&gt;prio );  \</span>
<span class="preprocessor">                (void)SetEvent( sma_is_rdy )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_SMA_UNREADY( rg, sma )                          \</span>
<span class="preprocessor">                rkh_rdy_rem( (rg), ((RKHSMA_T*)(sma))-&gt;romrkh-&gt;prio )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_WAIT_FOR_EVENTS()                               \</span>
<span class="preprocessor">                ((void)WaitForSingleObject( sma_is_rdy, (DWORD)INFINITE))</span>
</pre></div> <div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a348c60d5a5c6b1492ca55648e9aeeaf6" title="Initializes the RKH framework.">rkh_init</a>( <span class="keywordtype">void</span> )
{
    InitializeCriticalSection( &amp;csection );
    sma_is_rdy = CreateEvent( NULL, FALSE, FALSE, NULL );
}

<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a6b8f47b2f288dd0cf2c8b44dd062d509" title="RKH framework is started.">rkh_enter</a>( <span class="keywordtype">void</span> )
{
    rkhui8_t prio;
    <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma;
    <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e;

    RKH_HK_START();
    <a class="code" href="rkhtrc_8h.html#adc7d4420a30cd0208f897ec2bd9a0234">RKH_TRCR_RKH_EN</a>();
    running = 1;

    <span class="keywordflow">while</span>( running )
    {
        <a class="code" href="rkhitl_8h.html#a7401fd42aebee28b2e6eef2a9e4634e2" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_ENTER_CRITICAL</a>( dummy );
        <span class="keywordflow">if</span>( <a class="code" href="rkhrdy_8h.html#a8a93c5eb6c2a9ad46bf37cc21a4f5eea" title="This macro evaluates to TRUE if any SMA is ready to run.">rkh_rdy_isnot_empty</a>( rkhrg ) ) 
        {
            <a class="code" href="rkhrdy_8h.html#ab5ba4ef6e05e88daeff78572d9f7cab6" title="Finding the highest priority SMA ready to run.">rkh_rdy_findh</a>( rkhrg, prio );
            <a class="code" href="rkhitl_8h.html#a42bd908ca2b52b24bb823187ba800076" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_EXIT_CRITICAL</a>( dummy );

            sma = <a class="code" href="rkh_8h.html#a3a9318a6a79d7b808df2f75351ba0286" title="Priority arranged table of registered SMA.">rkh_sptbl</a>[ prio ];
            e = <a class="code" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get</a>( sma );
            <a class="code" href="rkh_8h.html#ae56c0173d50898325d8e64eac816399b" title="Executes a state machine in a non-preemtive model.">rkh_dispatch</a>( sma, e );
            <a class="code" href="rkh_8h.html#a5a62e6121174abd89d8a77b9ebef0736" title="Recycle a dynamic event.">RKH_GC</a>( e );
        }
        <span class="keywordflow">else</span>
            <a class="code" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle</a>();
    }

    <a class="code" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit</a>();
    CloseHandle( sma_is_rdy );
    DeleteCriticalSection( &amp;csection ); 
}

<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#ab18447f196fdd82c3d46617dff71a44c" title="Exit the RKH framework.">rkh_exit</a>( <span class="keywordtype">void</span> )
{
    <a class="code" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit</a>();
    <a class="code" href="rkhtrc_8h.html#ae8422f0d96033146cf769d944968faad">RKH_TRCR_RKH_EX</a>();
}

<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a02d78c8f4c9f8e2b9fb0cf57711c1220" title="Initializes and activates a previously created state machine application.">rkh_sma_activate</a>(   <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma, <span class="keyword">const</span> <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> **qs, <a class="code" href="rkhrq_8h.html#a9b92c95ab477eb8e6f81dd35e16923a3" title="This data type defines the maximum number of elements that any queue can contain.">RKH_RQNE_T</a> qsize, 
                        <span class="keywordtype">void</span> *stks, rkhui32_t stksize )
{
    ( void )stks;
    ( void )stksize;

    <a class="code" href="rkhrq_8h.html#a5ea237b158ef85877afd1d27ee765463" title="Initializes the previously allocated queue data strcuture RKHRQ_T.">rkh_rq_init</a>( &amp;sma-&gt;<a class="code" href="struct_r_k_h_s_m_a___t.html#ada52745b4c93d3ce9b3c54be210f668c" title="Event queue of the SMA.">equeue</a>, qs, qsize, sma );
    <a class="code" href="rkh_8h.html#aa66015888d344e3f9ebe604817dc19cc" title="Registers a state machine application into the framework, which implies to store a pointer to the SMA...">rkh_sma_register</a>( sma );
    <a class="code" href="rkh_8h.html#a395d701b816dd11bdd9835483607ae5f" title="Inits a previously created state machine calling its initializing action.">rkh_init_hsm</a>( sma );
    <a class="code" href="rkhtrc_8h.html#a966cd05e5ddf65df275a2a414e5d5c21">RKH_TRCR_SMA_ACT</a>( sma );
}

<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a4923f3d24f0f3cea38d598f5b7db203c" title="Terminate a state machine application.">rkh_sma_terminate</a>( <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma )
{
    <a class="code" href="rkh_8h.html#ab7f65892fe1948afc1b76a5f9eb0c8f0" title="Removes the SMA from the priority table, and thus from the framework, by simply replacing the link to...">rkh_sma_unregister</a>( sma );
    <a class="code" href="rkhtrc_8h.html#a12cc8760f638237c932580ae0c469462">RKH_TRCR_SMA_TERM</a>( sma );
}
</pre></div><p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macros <a class="el" href="rkhcfg_8h.html#a2b05aea5aa72e2666e2d6f9896d663e7">RKH_EN_NATIVE_SCHEDULER</a> = 1, <a class="el" href="rkhcfg_8h.html#aa7b19d3cf6f4f78817416319b154664b">RKH_EN_SMA_THREAD</a> = 0, and <a class="el" href="rkhcfg_8h.html#a0d0ced3d58eddc6c9d49c52ec91d0ae2">RKH_EN_SMA_THREAD_DATA</a> = 0, within the <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> file. </li>
<li>(2) Define the macros <a class="el" href="rkhitl_8h.html#a62eb26927897cf1441ddfe4caf8f1be2">RKH_EQ_TYPE</a> = <a class="el" href="struct_r_k_h_r_q___t.html" title="Defines the data structure used to maintain information about the queue.">RKHRQ_T</a>, <a class="el" href="rkhitl_8h.html#aef5296870b61cf45a868f02602e31340" title="Encapsulates the mechanism of blocking the event queue.">RKH_SMA_BLOCK()</a>, <a class="el" href="rkhitl_8h.html#a6775845b41cbe4a59cc936b0730623a3" title="Encapsulates the mechanism of signaling the thread waiting on the used event queue. Thus, the SMA is inserted in the ready list as ready-to-dispatch.">RKH_SMA_READY()</a>, <a class="el" href="rkhitl_8h.html#aade2f6ff9a19302e2b61e69b2417fde8" title="Informs the underlying kernel that the SMA event queue is becoming empty. Thus, the SMA is removed fr...">RKH_SMA_UNREADY()</a> in <b>rkhport.h</b>. </li>
<li>(3) When using the native shceduler (RKHS) is NOT necessary provides the functions <a class="el" href="rkh_8h.html#a348c60d5a5c6b1492ca55648e9aeeaf6" title="Initializes the RKH framework.">rkh_init()</a>, <a class="el" href="rkh_8h.html#a6b8f47b2f288dd0cf2c8b44dd062d509" title="RKH framework is started.">rkh_enter()</a>, <a class="el" href="rkh_8h.html#ab18447f196fdd82c3d46617dff71a44c" title="Exit the RKH framework.">rkh_exit()</a>, <a class="el" href="rkh_8h.html#a02d78c8f4c9f8e2b9fb0cf57711c1220" title="Initializes and activates a previously created state machine application.">rkh_sma_activate()</a>, and <a class="el" href="rkh_8h.html#a4923f3d24f0f3cea38d598f5b7db203c" title="Terminate a state machine application.">rkh_sma_terminate()</a>. </li>
<li>(4) Also, the macros RKH_EQ_TYPE, <a class="el" href="rkhitl_8h.html#aef5296870b61cf45a868f02602e31340" title="Encapsulates the mechanism of blocking the event queue.">RKH_SMA_BLOCK()</a>, </li>
<li>(5) <a class="el" href="rkhitl_8h.html#a6775845b41cbe4a59cc936b0730623a3" title="Encapsulates the mechanism of signaling the thread waiting on the used event queue. Thus, the SMA is inserted in the ready list as ready-to-dispatch.">RKH_SMA_READY()</a>, <a class="el" href="rkhitl_8h.html#aade2f6ff9a19302e2b61e69b2417fde8" title="Informs the underlying kernel that the SMA event queue is becoming empty. Thus, the SMA is removed fr...">RKH_SMA_UNREADY()</a> are RKH provided. In this mode of operation, RKH assumes the use of native priority scheme. See <b><a class="el" href="rkhs_8h.html" title="Platform-independent interface to the RKS scheduler.">rkhs.h</a></b>, <b>rkhs.c</b>, and <b><a class="el" href="rkhrdy_8h.html" title="Native priority management.">rkhrdy.h</a></b> files for more information.</li>
</ul>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="prio"></a>
Priority mechanism</h2>
<p><em>If RKH works in conjunction with a traditional OS/RTOS, RKH provides its own priority mechanism?</em></p>
<p><b>YES:</b> <br/>
 </p>
<ul>
<li>(1) Declare an <a class="el" href="struct_r_k_h_r_g___t.html" title="SMA ready table.">RKHRG_T</a> variable. </li>
<li>(2) Include the <b><a class="el" href="rkhrdy_8h.html" title="Native priority management.">rkhrdy.h</a></b> in rkhport.h. </li>
<li>(3) Then, the RKH port could be use the macros <a class="el" href="rkhrdy_8h.html#ab4c805018ada5dd7732cecf9bce22225" title="This macro evaluates to TRUE if all SMAs are not ready to run.">rkh_rdy_is_empty()</a>, <a class="el" href="rkhrdy_8h.html#a8a93c5eb6c2a9ad46bf37cc21a4f5eea" title="This macro evaluates to TRUE if any SMA is ready to run.">rkh_rdy_isnot_empty()</a>, <a class="el" href="rkhrdy_8h.html#a82ef2b607622f8a11891a328ce466624" title="Making a SMA ready-to-run inserting it into the ready list.">rkh_rdy_ins()</a>, <a class="el" href="rkhrdy_8h.html#a8080ba46f2cccbc43e098aa9a090092e" title="Removing a SMA from the ready list.">rkh_rdy_rem()</a>, and <a class="el" href="rkhrdy_8h.html#ab5ba4ef6e05e88daeff78572d9f7cab6" title="Finding the highest priority SMA ready to run.">rkh_rdy_findh()</a>. Frequently, the macros <a class="el" href="rkhitl_8h.html#aef5296870b61cf45a868f02602e31340" title="Encapsulates the mechanism of blocking the event queue.">RKH_SMA_BLOCK()</a>, <a class="el" href="rkhitl_8h.html#a6775845b41cbe4a59cc936b0730623a3" title="Encapsulates the mechanism of signaling the thread waiting on the used event queue. Thus, the SMA is inserted in the ready list as ready-to-dispatch.">RKH_SMA_READY()</a>, and <a class="el" href="rkhitl_8h.html#aade2f6ff9a19302e2b61e69b2417fde8" title="Informs the underlying kernel that the SMA event queue is becoming empty. Thus, the SMA is removed fr...">RKH_SMA_UNREADY()</a> use the macros provided by <b><a class="el" href="rkhrdy_8h.html" title="Native priority management.">rkhrdy.h</a></b>.</li>
</ul>
<p><b>NO:</b> <br/>
 Nothing to do.</p>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="eque"></a>
Event queue</h2>
<p><em>If RKH works in conjunction with a traditional OS/RTOS, are implemented the event queues with a message queue of the underlying OS/RTOS?</em></p>
<p><b>YES:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#a0b578217779d2c4c289f3732a815ce33">RKH_EN_NATIVE_EQUEUE</a> = 0 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
<li>(2) Define the macro <a class="el" href="rkhitl_8h.html#a62eb26927897cf1441ddfe4caf8f1be2">RKH_EQ_TYPE</a> = 0 in <b>rkhport.h</b> according to OS/RTOS. </li>
<li>(3) Then, implement the platform-specific functions <a class="el" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo()</a>, <a class="el" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo()</a> y <a class="el" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get()</a>. All these functions are placed in <b>rkhport.c</b> file.</li>
</ul>
<p><em>Generic example</em> </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo</a>( <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma, <span class="keyword">const</span> <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e )
{
    <a class="code" href="rkhitl_8h.html#a049663a78a9108ce08c76840a30ff798" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_SR_CRITICAL_</a>;
    
    RKH_HK_SIGNAL( e );
    RKH_ENTER_CRITICAL_();
    <span class="keywordflow">if</span>( RCE( e )-&gt;pool != 0 ) 
        ++RCE( e )-&gt;nref;
    RKH_EXIT_CRITICAL_();

    os_post_fifo_message( &amp;sma-&gt;<a class="code" href="struct_r_k_h_s_m_a___t.html#ada52745b4c93d3ce9b3c54be210f668c" title="Event queue of the SMA.">equeue</a>, e );
    <a class="code" href="rkhtrc_8h.html#ad88bacf87302f579ae3d778e3f8822a2">RKH_TRCR_SMA_FIFO</a>( sma, e );
}

<span class="keywordtype">void</span> 
<a class="code" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo</a>( <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma, <span class="keyword">const</span> <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e )
{
    <a class="code" href="rkhitl_8h.html#a049663a78a9108ce08c76840a30ff798" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_SR_CRITICAL_</a>;

    RKH_HK_SIGNAL( e );
    RKH_ENTER_CRITICAL_();
    <span class="keywordflow">if</span>( RCE( e )-&gt;pool != 0 ) 
        ++RCE( e )-&gt;nref;
    RKH_EXIT_CRITICAL_();

    os_post_lifo_message( &amp;sma-&gt;<a class="code" href="struct_r_k_h_s_m_a___t.html#ada52745b4c93d3ce9b3c54be210f668c" title="Event queue of the SMA.">equeue</a>, e );
    <a class="code" href="rkhtrc_8h.html#a85fb8097fa2f5337f6dc7fe1bc7c8c61">RKH_TRCR_SMA_LIFO</a>( sma, e );
}

<a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *
<a class="code" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get</a>( <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma )
{
    <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e;
    <a class="code" href="rkhitl_8h.html#a049663a78a9108ce08c76840a30ff798" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_SR_CRITICAL_</a>;

    RKH_ENTER_CRITICAL_();
    e = os_get_message( &amp;sma-&gt;<a class="code" href="struct_r_k_h_s_m_a___t.html#ada52745b4c93d3ce9b3c54be210f668c" title="Event queue of the SMA.">equeue</a> );
    <a class="code" href="rkhassert_8h.html#a44e0d6b7a49a3b03d45b88111391031d" title="The RKHASSERT() macro is used to check expressions that ought to be true as long as the program is ru...">RKHASSERT</a>( e != ( <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> * )0 );
    RKH_EXIT_CRITICAL_();

    <a class="code" href="rkhtrc_8h.html#a360f221f93f5e4060dd9849061be5f46">RKH_TRCR_SMA_GET</a>( sma, e );
    <span class="keywordflow">return</span> e;
}
</pre></div><p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#a0b578217779d2c4c289f3732a815ce33">RKH_EN_NATIVE_EQUEUE</a> = 1 y <a class="el" href="rkhcfg_8h.html#a3bea0299225d8085abd37d2de0582155">RKH_RQ_EN</a> = 1 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
<li>(2) When using the native event queues is NOT necessary provides neither the functions <a class="el" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo()</a>, <a class="el" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo()</a> nor <a class="el" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get()</a>. </li>
<li>(3) Define <a class="el" href="rkhitl_8h.html#a62eb26927897cf1441ddfe4caf8f1be2">RKH_EQ_TYPE</a> = <a class="el" href="struct_r_k_h_r_q___t.html" title="Defines the data structure used to maintain information about the queue.">RKHRQ_T</a> in <b>rkhport.h</b>.</li>
</ul>
<p><em>If the application code uses the RKH native scheduler, are implemented the event queues with the native queues <a class="el" href="struct_r_k_h_r_q___t.html" title="Defines the data structure used to maintain information about the queue.">RKHRQ_T</a>?</em></p>
<p><b>YES:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#a0b578217779d2c4c289f3732a815ce33">RKH_EN_NATIVE_EQUEUE</a> = 1 y <a class="el" href="rkhcfg_8h.html#a3bea0299225d8085abd37d2de0582155">RKH_RQ_EN</a> = 1 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
<li>(2) When using the native event queues is NOT necessary provides neither the functions <a class="el" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo()</a>, <a class="el" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo()</a> nor <a class="el" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get()</a>. </li>
<li>(3) Define <a class="el" href="rkhitl_8h.html#a62eb26927897cf1441ddfe4caf8f1be2">RKH_EQ_TYPE</a> = <a class="el" href="struct_r_k_h_r_q___t.html" title="Defines the data structure used to maintain information about the queue.">RKHRQ_T</a> in <b>rkhport.h</b>.</li>
</ul>
<p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#a0b578217779d2c4c289f3732a815ce33">RKH_EN_NATIVE_EQUEUE</a> = 0 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
<li>(2) Define the macro <a class="el" href="rkhitl_8h.html#a62eb26927897cf1441ddfe4caf8f1be2">RKH_EQ_TYPE</a> = 0 in <b>rkhport.h</b> according to OS/RTOS. </li>
<li>(3) Then, implement the platform-specific functions <a class="el" href="rkh_8h.html#ac11aaa38aefb41673027b1baa44fdd3b" title="Send an event to a state machine application through a queue using the FIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_fifo()</a>, <a class="el" href="rkh_8h.html#a8293c298ff040cc8277e6ded413f8037" title="Send an event to a state machine application through a queue using the LIFO policy. A message is a pointer size variable and its use is application specific.">rkh_sma_post_lifo()</a> y <a class="el" href="rkh_8h.html#af8993801a4f995bafb8870cde439cfb7" title="Get an event from the event queue of an state machine application. The events received are pointer si...">rkh_sma_get()</a>. All these functions are placed in <b>rkhport.c</b> file.</li>
</ul>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="dyn"></a>
Dynamic event support</h2>
<p><em>Is required events with arguments?</em></p>
<p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macros <a class="el" href="rkhcfg_8h.html#aaec7e4da63ca0f9d4d45ae22fa8d250e">RKH_EN_DYNAMIC_EVENT</a> = 0 and <a class="el" href="rkhcfg_8h.html#a51733bf9ffb1aceb18d950fd4cce5a93">RKH_EN_NATIVE_DYN_EVENT</a> = 0 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b>.</li>
</ul>
<p><b>YES:</b> <br/>
</p>
<p><em>If RKH works in conjunction with a traditional OS/RTOS, is implemented the dynamic memory support with a internal module of the underlying OS/RTOS?</em></p>
<p><b>YES:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#aaec7e4da63ca0f9d4d45ae22fa8d250e">RKH_EN_DYNAMIC_EVENT</a> = 1 and <a class="el" href="rkhcfg_8h.html#a51733bf9ffb1aceb18d950fd4cce5a93">RKH_EN_NATIVE_DYN_EVENT</a> = 0 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
<li>(2) Define the macros RKH_DYNE_TYPE, <a class="el" href="rkhitl_8h.html#a4b5aee3c127ac9c2618c2452b6bd65b2" title="Encapsulates the creation of a event pool.">RKH_DYNE_INIT()</a>, <a class="el" href="rkhitl_8h.html#ae5c52c17f40c4119b0aebffacf4ecb04" title="Encapsulates how RKH should obtain the block size of pool.">RKH_DYNE_GET_ESIZE()</a>, <a class="el" href="rkhitl_8h.html#a90dcc5b49faff4d8dde016f8aea160fa" title="Encapsulates how RKH should obtain an event e from the event pool mp.">RKH_DYNE_GET()</a> y <a class="el" href="rkhitl_8h.html#a3d3e4448b8b4fdaef1501bf2723b0cde" title="Encapsulates how RKH should return an event e to the event pool mp.">RKH_DYNE_PUT()</a> in <b>rkhport.h</b> according to underlying OS/RTOS.</li>
</ul>
<p><em>Generic example</em> </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#define RKH_DYNE_TYPE           RKHMP_T</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_DYNE_INIT( mp, sstart, ssize, esize )   \</span>
<span class="preprocessor">            rkh_mp_init( (mp),sstart,(rkhui16_t)ssize,(RKH_MPBS_T)esize )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_DYNE_GET_ESIZE( mp )                    \</span>
<span class="preprocessor">            ( (mp)-&gt;bsize )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_DYNE_GET( mp, e )                       \</span>
<span class="preprocessor">            ( (e) = (RKHEVT_T*)rkh_mp_get( (mp) ) )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_DYNE_PUT( mp, e )                       \</span>
<span class="preprocessor">            ( rkh_mp_put( (mp), e ) )</span>
</pre></div><p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#aaec7e4da63ca0f9d4d45ae22fa8d250e">RKH_EN_DYNAMIC_EVENT</a> = 1, <a class="el" href="rkhcfg_8h.html#a51733bf9ffb1aceb18d950fd4cce5a93">RKH_EN_NATIVE_DYN_EVENT</a> = 0, and <a class="el" href="rkhcfg_8h.html#ab893f2b2e3aba36212400404842235f9">RKH_MP_EN</a> = 1 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
</ul>
<p><em>If the application code uses the RKH native scheduler, is implemented the dynamic memory support with the native fixed-size memory block pool <a class="el" href="struct_r_k_h_m_p___t.html" title="Defines the data structure used to memory block pool facility.">RKHMP_T</a>?</em></p>
<p><b>YES:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#aaec7e4da63ca0f9d4d45ae22fa8d250e">RKH_EN_DYNAMIC_EVENT</a> = 1 and <a class="el" href="rkhcfg_8h.html#a51733bf9ffb1aceb18d950fd4cce5a93">RKH_EN_NATIVE_DYN_EVENT</a> = 0 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
</ul>
<p><b>NO:</b> <br/>
 </p>
<ul>
<li>(1) Define the macro <a class="el" href="rkhcfg_8h.html#aaec7e4da63ca0f9d4d45ae22fa8d250e">RKH_EN_DYNAMIC_EVENT</a> = 1, <a class="el" href="rkhcfg_8h.html#a51733bf9ffb1aceb18d950fd4cce5a93">RKH_EN_NATIVE_DYN_EVENT</a> = 0, and <a class="el" href="rkhcfg_8h.html#ab893f2b2e3aba36212400404842235f9">RKH_MP_EN</a> = 1 in <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> </li>
</ul>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="hk"></a>
Hook functions</h2>
<p>A RKH port cannot and should not define all the functions that it calls, because this would render the port too inflexible. The functions that RKH calls but doesn't actually implement are referred to as callback or hook functions. All these functions in RKH are easily indentifiable by the <b>"_hk_"</b> key word used in the function name, <a class="el" href="rkh_8h.html#a3572f6e590c0480ae6c38cb52591548c" title="When dispatching an event to a SMA the dispatch hook function will be executed.">rkh_hk_dispatch()</a>, <a class="el" href="rkh_8h.html#ae9e0cf19deea17d51c606b097376693d" title="When the producer of an event directly posts the event to the event queue of the consumer SMA the rkh...">rkh_hk_signal()</a>, <a class="el" href="rkh_8h.html#aa1d038df594d55a40edb5216f93587e1" title="If a timer expires the rkh_hk_timeout() function is called just before the assigned event is directly...">rkh_hk_timeout()</a>, <a class="el" href="rkh_8h.html#a8e824db08ba7430b74762a487804812b" title="This hook function is called just before the RKH takes over control of the application.">rkh_hk_start()</a>, <a class="el" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit()</a>, and <a class="el" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle()</a>. Please, see RKH_HK_EN_DISPATCH, RKH_HK_EN_SIGNAL, RKH_HK_EN_TIMEOUT, RKH_HK_EN_START, and RKH_HK_EN_EXIT options from the <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b>.<br/>
</p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a3572f6e590c0480ae6c38cb52591548c" title="When dispatching an event to a SMA the dispatch hook function will be executed.">rkh_hk_dispatch</a>( <a class="code" href="struct_r_k_h_s_m_a___t.html" title="Describes the SMA (active object in UML).">RKHSMA_T</a> *sma, <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e )
</pre></div> <p>If the <a class="el" href="rkhcfg_8h.html#a0c650c7576b36153be4b2e93f93b175b">RKH_HK_EN_DISPATCH</a> is set to 1, RKH will invoke the dispatch hook function <a class="el" href="rkh_8h.html#a3572f6e590c0480ae6c38cb52591548c" title="When dispatching an event to a SMA the dispatch hook function will be executed.">rkh_hk_dispatch()</a> when dispatching an event to a SMA. When this is set the application must provide the hook function. </p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#ae9e0cf19deea17d51c606b097376693d" title="When the producer of an event directly posts the event to the event queue of the consumer SMA the rkh...">rkh_hk_signal</a>( <a class="code" href="struct_r_k_h_e_v_t___t.html" title="Represents events without parameters.">RKHEVT_T</a> *e )
</pre></div> <p>If the <a class="el" href="rkhcfg_8h.html#a3f85f2932bfd01c4911626690f508fd2">RKH_HK_EN_SIGNAL</a> is set to 1, RKH will invoke the signal hook function <a class="el" href="rkh_8h.html#ae9e0cf19deea17d51c606b097376693d" title="When the producer of an event directly posts the event to the event queue of the consumer SMA the rkh...">rkh_hk_signal()</a> when the producer of an event directly posts the event to the event queue of the consumer SMA. When this is set the application must provide the hook function. </p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#aa1d038df594d55a40edb5216f93587e1" title="If a timer expires the rkh_hk_timeout() function is called just before the assigned event is directly...">rkh_hk_timeout</a>( <span class="keyword">const</span> <span class="keywordtype">void</span> *t )
</pre></div> <p>If the <a class="el" href="rkhcfg_8h.html#a4b090bc62a37aeee1a689a4647b99f9b">RKH_HK_EN_TIMEOUT</a> is set to 1, RKH will invoke the timeout hook function <a class="el" href="rkh_8h.html#aa1d038df594d55a40edb5216f93587e1" title="If a timer expires the rkh_hk_timeout() function is called just before the assigned event is directly...">rkh_hk_timeout()</a> when a timer expires just before the assigned event is directly posted into the state machine application queue. When this is set the application must provide the hook function. </p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a8e824db08ba7430b74762a487804812b" title="This hook function is called just before the RKH takes over control of the application.">rkh_hk_start</a>( <span class="keywordtype">void</span> )
</pre></div> <p>If the <a class="el" href="rkhcfg_8h.html#a9d27d7ecf620565a8fd103393aed26ac">RKH_HK_EN_START</a> is set to 1, RKH will invoke the start hook function <a class="el" href="rkh_8h.html#a8e824db08ba7430b74762a487804812b" title="This hook function is called just before the RKH takes over control of the application.">rkh_hk_start()</a> just before the RKH takes over control of the application. When this is set the application must provide the hook function. </p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit</a>( <span class="keywordtype">void</span> )
</pre></div> <p>If the <a class="el" href="rkhcfg_8h.html#a4ae0b727efe3a73efb86088fee58ea1e">RKH_HK_EN_EXIT</a> is set to 1, RKH will invoke the exit hook function just before it returns to the underlying OS/RTOS. Usually, the <a class="el" href="rkh_8h.html#a2a7e209c4a5e7cd493d7e8870b576583" title="This hook function is called just before the RKH returns to the underlying OS/RTOS. Usually, the rkh_hk_exit() is useful when executing clean-up code upon SMA terminate or framework exit.">rkh_hk_exit()</a> is useful when executing clean-up code upon SMA terminate or framework exit. When this is set the application must provide the hook function. </p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle</a>( <span class="keywordtype">void</span> )
</pre></div> <p>This makes the idle hook function an ideal place to put the processor into a low power state - providing an automatic power saving whenever there is no processing to be performed.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The <a class="el" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle()</a> callback is called with interrupts locked, because the determination of the idle condition might change by any interrupt posting an event. This function must internally unlock interrupts, ideally atomically with putting the CPU to the power-saving mode.</dd></dl>
<p>Example:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span>
    <a class="code" href="rkh_8h.html#a5edbaf8597b0b92d05d80dfddd891d52" title="An idle hook function will only get executed (with interrupts LOCKED) when there are no SMAs of highe...">rkh_hk_idle</a>( <span class="keywordtype">void</span> )         <span class="comment">// NOTE: entered with interrupts DISABLED</span>
    {
        <a class="code" href="rkhitl_8h.html#aed1d3d5ccbd9ff2fb694e809e494759d">RKH_ENA_INTERRUPT</a>();    <span class="comment">// must at least enable interrupts</span>
        ...
    }
</pre></div> <p><br/>
 <hr/>
 <h2><a class="anchor" id="ilock"></a>
Interrupt locking mechanism</h2>
<p>RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts when done. This allows RKH to protect critical code from being entered simultaneously. To hide the implementation method chosen by the processor, compiler, etc, RKH defines two macros to unconditionally disable and enable interrupts: <a class="el" href="rkhitl_8h.html#a5e8366e36b0290e15bd75988390cc760">RKH_DIS_INTERRUPT()</a> and <a class="el" href="rkhitl_8h.html#aed1d3d5ccbd9ff2fb694e809e494759d">RKH_ENA_INTERRUPT()</a> respectively. Obviously, they resides in <b>rkhport.h</b> file, which the user always need to provide.</p>
<p><em>Example for HCS08 CW6.3 from C:</em> </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #define RKH_DIS_INTERRUPT()         DisableInterrupts</span>
<span class="preprocessor">    #define RKH_ENA_INTERRUPT()         EnableInterrupts</span>
</pre></div>  Please, see <a class="el" href="_installation.html">Installation</a> section about RKH port directory and files.</p>
<p><br/>
 <hr/>
 <h2><a class="anchor" id="crt"></a>
Critical section</h2>
<p>This allows RKH to protect critical code from being entered simultaneously from either multiple SMAs or ISRs. Every processor generally provide instructions to disable/enable interrupts and the C compiler must have a mechanism to perform these operations directly from C. Some compilers will allows to insert in-line assembly language statements in the C source code. This makes it quite easy to insert processor instructions to enable and disable interrupts. Other compilers will actually contain language extensions to enable and disable interrupts directly from C. To hide the implementation method chosen by the compiler manufacturer, RKH defines two macros to disable and enable interrupts: <a class="el" href="rkhitl_8h.html#a7401fd42aebee28b2e6eef2a9e4634e2" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_ENTER_CRITICAL()</a> and <a class="el" href="rkhitl_8h.html#a42bd908ca2b52b24bb823187ba800076" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_EXIT_CRITICAL()</a>.</p>
<p>The <a class="el" href="rkhitl_8h.html#a7401fd42aebee28b2e6eef2a9e4634e2" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_ENTER_CRITICAL()</a> macro saves the interrupt disable status onto the stack and then, disable interrupts. <a class="el" href="rkhitl_8h.html#a42bd908ca2b52b24bb823187ba800076" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_EXIT_CRITICAL()</a> would simply be implemented by restoring the interrupt status from the stack. Using this scheme, if it's called a RKH service with either interrupts enabled or disabled then, the status would be preserved across the call. If calls a RKH service with interrupts disabled, is potentially extending the interrupt latency of application. The application can use <a class="el" href="rkhitl_8h.html#a7401fd42aebee28b2e6eef2a9e4634e2" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_ENTER_CRITICAL()</a> and <a class="el" href="rkhitl_8h.html#a42bd908ca2b52b24bb823187ba800076" title="RKH need to disable interrupts in order to access critical sections of code, and re-enable interrupts...">RKH_EXIT_CRITICAL()</a> to also protect critical sections of code. As a general rule, should always call RKH services with interrupts enabled!.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>These macros are internal to RKH and the user application should not call it.</dd></dl>
<p><em>Example for x86, VC2008, and win32 single thread:</em> </p>
<div class="fragment"><pre class="fragment">    <span class="comment">//#define RKH_CPUSR_TYPE</span>
<span class="preprocessor">    #define RKH_ENTER_CRITICAL( dummy )     EnterCriticalSection( &amp;csection )</span>
<span class="preprocessor">    #define RKH_EXIT_CRITICAL( dummy )      LeaveCriticalSection( &amp;csection )</span>
</pre></div> <p><br/>
 <hr/>
 <h2><a class="anchor" id="trc"></a>
Trace facility</h2>
<p>When a program needs to be traced, it has to generate some information each time it reaches a "significant step" (certain instruction in the program's source code). In the standard terminology, this step is called a trace point, and the tracing information which is generated at that point is called a trace event. A program containing one or more of this trace points is named instrumented application.</p>
<p>The definition of events and the mapping between these and their corresponding names is hard-coded in the RKH implementation. Therefore, these events are common for all the state machine applications and never change (they are always traced). The trace events are associated with a integer value and are explicity listed and defined (enumerated) as shown below in this file.</p>
<p>The standard defines that the trace system has to store some information for each trace event (also named arguments) being generated, including, at least, the following:</p>
<ul>
<li>the trace event identifier (<a class="el" href="rkhtrc_8h.html#a4705ca08d69d80441ecb18b0c9f36c8a" title="RKH trace events.">RKH_TRC_EVENTS</a> enumerated list),</li>
<li>a timestamp (optional),</li>
<li>any extra data that the system wants to associate with the event (optional).</li>
</ul>
<p>When the system or an application trace an event, all the information related to it has to be stored somewhere before it can be retrieved, in order to be analyzed. This place is a trace stream. Formally speaking, a trace stream is defined as a non-persistent, internal (opaque) data object containing a sequence of trace events plus some internal information to interpret those trace events.</p>
<p>Also, the streams support runtime filtering. The application can define and apply a filter to a trace stream. Basically, the filter establishes which event types the stream is accepting (and hence storing) and which are not. Therefore, trace events corresponding to types which are filtered out from a certain stream will not be stored in the stream. The stream in the system can potentially be applied a different filter. This filter can be applied, removed or changed at any time.</p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="rkhtrc_8h.html#a4705ca08d69d80441ecb18b0c9f36c8a" title="RKH trace events.">RKH_TRC_EVENTS</a> the enumerated list of RKH trace events. </dd></dl>
<p>RKH has a set of configuration options related to trace tool facility, which an user that require this feature must be properly configure in the <b><a class="el" href="rkhcfg_8h.html" title="RKH user configuration.">rkhcfg.h</a></b> header file.</p>
<ul>
<li>Define the macro <b>RKH_TRC_EN</b> <p>If the <a class="el" href="rkhcfg_8h.html#a1a11f723b627bc6f80a5f0f3f7fcebbb">RKH_TRC_EN</a> is set to 1 then RKH will include the trace facility. </p>
 </li>
<li>Define the macro <b>RKH_TRC_MAX_EVENTS</b> <p>Specify the maximum number of trace events, this number is direclty related with the <a class="el" href="rkhtrc_8h.html#a4705ca08d69d80441ecb18b0c9f36c8a" title="RKH trace events.">RKH_TRC_EVENTS</a> enumeration. The smaller this number, the lower the RAM consumption. See <code><a class="el" href="rkhtrc_8h.html#a02547388aafb3159679512f99d3b42e1" title="Filter table of trace events.">trceftbl</a></code> table. </p>
 </li>
<li>Define the macro <b>RKH_TRC_RUNTIME_FILTER</b> <p>If the <a class="el" href="rkhcfg_8h.html#a21d46721322d9d87b72327d71797c94f">RKH_TRC_RUNTIME_FILTER</a> is set to 1 then RKH will include the runtime trace filter facility. When <a class="el" href="rkhcfg_8h.html#a21d46721322d9d87b72327d71797c94f">RKH_TRC_RUNTIME_FILTER</a> is enabled RKH also will automatically define <a class="el" href="rkhtrc_8h.html#a9387ef53b10bb4ac4a9297dbea049054" title="Suppress all trace events from a specific group.">RKH_FILTER_ON_GROUP()</a>, <a class="el" href="rkhtrc_8h.html#af8281a1c79d543f23ff09a33ed3d6efb" title="Emit all trace events from a specific group.">RKH_FILTER_OFF_GROUP()</a>, <a class="el" href="rkhtrc_8h.html#a6a34d237fcca3526f478ce6eb5a31900" title="Suppress one trace events from a specific group.">RKH_FILTER_ON_EVENT()</a>, <a class="el" href="rkhtrc_8h.html#a39abbf4845ab85a377a402b4655526fd" title="Emit one trace events from a specific group.">RKH_FILTER_OFF_EVENT()</a>, <a class="el" href="rkhtrc_8h.html#acd0f533a6270e219993e7c4ffcdcac46" title="Suppress a specific event in a specific group.">RKH_FILTER_ON_GROUP_EVENT()</a>, and <a class="el" href="rkhtrc_8h.html#acff69866423c3151d21223b7ea45e1c8" title="Emit a specific event in a specific group.">RKH_FILTER_OFF_GROUP_EVENT()</a> macros. </p>
 </li>
<li>Define the macro <b>RKH_TRC_ALL</b> <p>If the <a class="el" href="rkhcfg_8h.html#a485d6d3a1e65dc63aa81857dba541997">RKH_TRC_ALL</a> is set to 1 then RKH will include all its own trace records. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_MP</b> <p>If the <a class="el" href="rkhcfg_8h.html#acde5a28204f1a7a303663af32beef0e9">RKH_TRC_EN_MP</a> is set to 1 then RKH will include all trace records related to the native fixed-size memory blocks. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_RQ</b> <p>If the <a class="el" href="rkhcfg_8h.html#acec02c16205d1228e46b2b2bfe52ec0a">RKH_TRC_EN_RQ</a> is set to 1 then RKH will include all trace records related to the native queues. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SMA</b> <p>If the <a class="el" href="rkhcfg_8h.html#a9dd1a756634cb8bbf7ddae104a8b20c2">RKH_TRC_EN_SMA</a> is set to 1 then RKH will include all trace records related to the state machine applications. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_TIM</b> <p>If the <a class="el" href="rkhcfg_8h.html#a254c4c6b7d6b2c86e2ceb5d78846a8e3">RKH_TRC_EN_TIM</a> is set to 1 then RKH will include all trace records related to the native software timer. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM</b> <p>If the <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> is set to 1 then RKH will include all trace records related to the state machine (hierarchical and "flat"). </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_RKH</b> <p>If the <a class="el" href="rkhcfg_8h.html#a92242d21f21820a56c925b74ba9ba0d4">RKH_TRC_EN_RKH</a> is set to 1 then RKH will include all trace records related to the nativenative event framework. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_INIT</b> <p>If the <a class="el" href="rkhcfg_8h.html#ae3f763011730984c14f5253a351ffa7e">RKH_TRC_EN_SM_INIT</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "init state machine" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_DCH</b> <p>If the <a class="el" href="rkhcfg_8h.html#aa1a46c1d4a01c9b42737b478752c85c9">RKH_TRC_EN_SM_DCH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "dispatch an event" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_CLRH</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "clear the history pseudostate" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_TRN</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "clear the history pseudostate" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_STATE</b> <p>If the <a class="el" href="rkhcfg_8h.html#a27f16f3bff5b3200638f16a7e742e5fb">RKH_TRC_EN_SM_STATE</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "final state of transition" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_ENSTATE</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "entry state" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_EXSTATE</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "exit state" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_NENEX</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "number of entry and exit states in the transition" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_NTRNACT</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "number of executed actions in the transition" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_CSTATE</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "state or pseudostate in a compound transition" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_SM_DCH_RC</b> <p>If the <a class="el" href="rkhcfg_8h.html#a796496c4ecc39ce55b3ca57b7d4e986f">RKH_TRC_EN_SM_CLRH</a> and <a class="el" href="rkhcfg_8h.html#a04637ebe74b7f5181fcf47058cbb01d2">RKH_TRC_EN_SM</a> are set to 1 then RKH will include the "returned code from dispatch function" trace record. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_NSEQ</b> <p>If the <a class="el" href="rkhcfg_8h.html#af7c0f4d0fca41d244dc0d41cfad7300e">RKH_TRC_EN_NSEQ</a> is set to 1 then RKH will add to the trace record an incremental number (1-byte), used like a sequence number. See <a class="el" href="rkhtrc_8h.html#a2d30bb12abf7cedef15fbaf330cea32f" title="Insert the sequence number byte.">RKH_TRC_NSEQ()</a> and <a class="el" href="rkhtrc_8h.html#a51687ed69015834201c9962ab611a291" title="Insert the trace event header in the stream.">RKH_TRC_HDR()</a> macros. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_CHK</b> <p>If the <a class="el" href="rkhcfg_8h.html#a24065b97a16aeb6cca1b822764d7a35c">RKH_TRC_EN_CHK</a> is set to 1 then RKH will add to the trace record a checksum (1-byte). See <a class="el" href="rkhtrc_8h.html#a78908762cf054d5c1a711e5d3ae3d20c" title="Inserts the previously calculated checksum as: checksum = 0 - sum mod-256 -&gt; ~(sum mod-256) + 1...">RKH_TRC_CHK()</a> macro. </p>
 </li>
<li>Define the macro <b>RKH_TRC_EN_TSTAMP</b> <p>If the <a class="el" href="rkhcfg_8h.html#a293a5e3a0cb5a241c64793f06ac653d9">RKH_TRC_EN_TSTAMP</a> is set to 1 then RKH will add to the trace record a timestamp field. It's configurable by means of <a class="el" href="rkhcfg_8h.html#a7578c16664c9e40b84a22e10ec3d44f3">RKH_TRC_SIZEOF_TSTAMP</a>. </p>
 </li>
<li>Define the macro <b>RKH_TRC_SIZEOF_TSTAMP</b> <p>Specify the number of bytes (size) used by the trace record timestamp. The valid values [in bits] are 8, 16 or 32. Default is 16. </p>
 </li>
<li>Define the macro <b>RKH_TRC_SIZEOF_STREAM</b> <p>Specify the maximum number of trace events in the stream. The smaller this number, the lower the RAM consumption. </p>
 </li>
<li>Define the macro <b>RKH_TRC_SIZEOF_POINTER</b> <p>Specify the size of void pointer. The valid values [in bits] are 16 or 32. Default is 32. See <a class="el" href="rkhtrc_8h.html#a11d021b2ee9cb943fa3d6fec6a33401e" title="Insert a object address as trace record argument.">RKH_TRC_SYM()</a> macro. </p>
</li>
</ul>
<p>See <a class="el" href="cfg.html">Configuration</a> section for more information about that.</p>
<p>A RKH port cannot and should not define all the functions that it calls, because this would render the port too inflexible. Therefore, the application-specific functions <a class="el" href="rkh_8h.html#a01e6ed5f8d81d1e3ec5bf32d44a4bab6" title="Open the tracing session.">rkh_trc_open()</a>, <a class="el" href="rkh_8h.html#a82ea03425018b8a70571b3499b70e8d3" title="Close the tracing session.">rkh_trc_close()</a>, <a class="el" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush()</a>, and <a class="el" href="rkh_8h.html#ac289dc76e3dc4fdc23691782caa3aab9" title="Retrieves a timestamp to be placed in a trace event.">rkh_trc_getts()</a> are application provided.</p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a01e6ed5f8d81d1e3ec5bf32d44a4bab6" title="Open the tracing session.">rkh_trc_open</a>( <span class="keywordtype">void</span> )
</pre></div> <p>This function is application-specific and the user needs to define it. At a minimum, the function must configure the trace stream by calling <a class="el" href="rkhtrc_8h.html#a8b7d1e9c3b57e75d0b5289282afdd10e" title="Initializes the RKH&#39;s trace record service.">rkh_trc_init()</a> function.</p>
<p>Example:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> 
    <a class="code" href="rkh_8h.html#a01e6ed5f8d81d1e3ec5bf32d44a4bab6" title="Open the tracing session.">rkh_trc_open</a>( <span class="keywordtype">void</span> )
    {
        <a class="code" href="rkhtrc_8h.html#a8b7d1e9c3b57e75d0b5289282afdd10e" title="Initializes the RKH&#39;s trace record service.">rkh_trc_init</a>();
        <a class="code" href="rkhtrc_8h.html#a88a14ad1c20c7ebcd54c30a1265a056e" title="Starts or stops the tracing session.">rkh_trc_control</a>( RKH_TRC_START );

        <span class="keywordflow">if</span>( ( fdbg = fopen( <span class="stringliteral">&quot;../ahlog.txt&quot;</span>, <span class="stringliteral">&quot;w+&quot;</span> ) ) == NULL )
        {
            perror( <span class="stringliteral">&quot;Can&#39;t open file\n&quot;</span> );
            exit( EXIT_FAILURE );
        }
<span class="preprocessor">    #if BIN_TRACE == 1</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>( ( ftbin = fopen( <span class="stringliteral">&quot;../ftbin&quot;</span>, <span class="stringliteral">&quot;w+b&quot;</span> ) ) == NULL )
        {
            perror( <span class="stringliteral">&quot;Can&#39;t open file\n&quot;</span> );
            exit( EXIT_FAILURE );
        }
<span class="preprocessor">    #endif</span>
<span class="preprocessor"></span>        trazer_init();
    }
</pre></div><dl class="see"><dt><b>See also:</b></dt><dd><b><a class="el" href="rkhtrc_8h.html" title="Platform-independent interface for RKH trace facility.">rkhtrc.h</a></b> file. </dd></dl>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a82ea03425018b8a70571b3499b70e8d3" title="Close the tracing session.">rkh_trc_close</a>( <span class="keywordtype">void</span> )
</pre></div> <p>This function is application-specific and the user needs to define it. At a minimum, the function must configure the trace stream by calling <a class="el" href="rkhtrc_8h.html#a8b7d1e9c3b57e75d0b5289282afdd10e" title="Initializes the RKH&#39;s trace record service.">rkh_trc_init()</a> function.</p>
<p>Example:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> 
    <a class="code" href="rkh_8h.html#a82ea03425018b8a70571b3499b70e8d3" title="Close the tracing session.">rkh_trc_close</a>( <span class="keywordtype">void</span> )
    {
        fclose( fdbg );
<span class="preprocessor">    #if BIN_TRACE == 1</span>
<span class="preprocessor"></span>        fclose( ftbin );
<span class="preprocessor">    #endif</span>
<span class="preprocessor">    }</span>
</pre></div><dl class="see"><dt><b>See also:</b></dt><dd><b><a class="el" href="rkhtrc_8h.html" title="Platform-independent interface for RKH trace facility.">rkhtrc.h</a></b> file. </dd></dl>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush</a>( <span class="keywordtype">void</span> )
</pre></div> <p>This function is application-specific and the user needs to define it. When the RKH trace an event, all the information related to it has to be stored somewhere before it can be retrieved, in order to be analyzed. This place is a trace stream. Frequently, events traced are stored in the stream until it is flushed.</p>
<p>Example:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> 
    <a class="code" href="rkh_8h.html#a40281729b441d54e4118a6809540bb2f" title="Platform-dependent macro flushing the trace stream.">rkh_trc_flush</a>( <span class="keywordtype">void</span> )
    {
        rkhui8_t *d;
        
        <span class="keywordflow">while</span>( ( d = <a class="code" href="rkhtrc_8h.html#a010da69e7e79a10723f60d37e60be609" title="Retrieves a pointer to oldest stored byte in the trace stream. Frequently, this function is used by t...">rkh_trc_get</a>() ) != ( rkhui8_t* )0 )
        {
            ftbin_flush( d );
            trazer_parse( *d );
        }
    }
</pre></div><dl class="see"><dt><b>See also:</b></dt><dd><b><a class="el" href="rkhtrc_8h.html" title="Platform-independent interface for RKH trace facility.">rkhtrc.h</a></b> file. </dd></dl>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> <a class="code" href="rkh_8h.html#ac289dc76e3dc4fdc23691782caa3aab9" title="Retrieves a timestamp to be placed in a trace event.">rkh_trc_getts</a>( <span class="keywordtype">void</span> )
</pre></div> <p>This function is application-specific and the user needs to define it. At a minimum, the function must configure the trace stream by calling <a class="el" href="rkhtrc_8h.html#a8b7d1e9c3b57e75d0b5289282afdd10e" title="Initializes the RKH&#39;s trace record service.">rkh_trc_init()</a> function. The data returned is defined in compile-time by means of RKH_SIZEOF_TSTAMP.</p>
<p>Example:</p>
<div class="fragment"><pre class="fragment">    <a class="code" href="rkhtrc_8h.html#a35f6c91d6f5a83e634f757e867290186" title="Defines the size of trace timestamp.">RKHTS_T</a> 
    <a class="code" href="rkh_8h.html#ac289dc76e3dc4fdc23691782caa3aab9" title="Retrieves a timestamp to be placed in a trace event.">rkh_trc_getts</a>( <span class="keywordtype">void</span> )
    {
        <span class="keywordflow">return</span> ( <a class="code" href="rkhtrc_8h.html#a35f6c91d6f5a83e634f757e867290186" title="Defines the size of trace timestamp.">RKHTS_T</a> )clock();
    }
</pre></div><dl class="return"><dt><b>Returns:</b></dt><dd>Timestamp (RKHTS_T data type).</dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><b><a class="el" href="rkhtrc_8h.html" title="Platform-independent interface for RKH trace facility.">rkhtrc.h</a></b> file. </dd></dl>
<hr/>
 <h2><a class="anchor" id="rkhp"></a>
A port file example.</h2>
<p><em><b>"rkhport.h"</b> for x86, VC2008, and win32 single thread</em> <em> (\source\portable\80x86\win32_st\vc08)</em></p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#ifndef __RKHPORT_H__</span>
<span class="preprocessor"></span><span class="preprocessor">#define __RKHPORT_H__</span>
<span class="preprocessor"></span>

<span class="preprocessor">#include &lt;windows.h&gt;</span>

<span class="preprocessor">#include &quot;<a class="code" href="rkhtype_8h.html" title="This file defines the data types that uses RKH.">rkhtype.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="rkhrq_8h.html" title="Platform-independent interface for supporting queue (by reference) services.">rkhrq.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="rkhmp_8h.html" title="Platform-independent interface for supporting fixed-size memory blocks facility.">rkhmp.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="rkhrdy_8h.html" title="Native priority management.">rkhrdy.h</a>&quot;</span>


<span class="keyword">extern</span> CRITICAL_SECTION csection;
<span class="keyword">extern</span> HANDLE sma_is_rdy;
<span class="keyword">extern</span> <a class="code" href="struct_r_k_h_r_g___t.html" title="SMA ready table.">RKHRG_T</a> rkhrg;


<span class="keyword">const</span> <span class="keywordtype">char</span> *rkh_get_port_version( <span class="keywordtype">void</span> );
<span class="keyword">const</span> <span class="keywordtype">char</span> *rkh_get_port_desc( <span class="keywordtype">void</span> );


<span class="comment">/*</span>
<span class="comment">    Declaring an object RKHROM announces that its value will</span>
<span class="comment">    not be changed and it will be stored in ROM.</span>
<span class="comment"> */</span>

<span class="preprocessor">#define RKHROM          const   </span>
<span class="preprocessor"></span>

<span class="preprocessor">#define RKH_DIS_INTERRUPT()</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_ENA_INTERRUPT()</span>
<span class="preprocessor"></span><span class="comment">//#define RKH_CPUSR_TYPE</span>
<span class="preprocessor">#define RKH_ENTER_CRITICAL( dummy )     EnterCriticalSection( &amp;csection )</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_EXIT_CRITICAL( dummy )      LeaveCriticalSection( &amp;csection )</span>
<span class="preprocessor"></span>

<span class="preprocessor">#define RKH_EQ_TYPE                     RKHRQ_T</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_OSDATA_TYPE                 HANDLE</span>
<span class="preprocessor"></span><span class="preprocessor">#define RKH_THREAD_TYPE                 HANDLE</span>
<span class="preprocessor"></span>

<span class="preprocessor">#define RKH_SMA_BLOCK( sma )                                    \</span>
<span class="preprocessor">                RKHASSERT( ((RKHSMA_T*)(sma))-&gt;equeue.qty != 0 )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_SMA_READY( rg, sma )                                \</span>
<span class="preprocessor">                rkh_rdy_ins( (rg), ((RKHSMA_T*)(sma))-&gt;romrkh-&gt;prio );  \</span>
<span class="preprocessor">                (void)SetEvent( sma_is_rdy )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_SMA_UNREADY( rg, sma )                              \</span>
<span class="preprocessor">                rkh_rdy_rem( (rg), ((RKHSMA_T*)(sma))-&gt;romrkh-&gt;prio )</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define RKH_WAIT_FOR_EVENTS()                                   \</span>
<span class="preprocessor">                ((void)WaitForSingleObject( sma_is_rdy, (DWORD)INFINITE))</span>
<span class="preprocessor"></span>

<span class="preprocessor">#endif</span>
</pre></div><p><em><b>"rkht.h"</b> for x86, VC2008, and win32 single thread</em> <em> (\source\portable\80x86\win32_st\vc08)</em></p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#ifndef __RKHT_H__</span>
<span class="preprocessor"></span><span class="preprocessor">#define __RKHT_H__</span>
<span class="preprocessor"></span>

<span class="comment">/*</span>
<span class="comment">    Portable data types.</span>
<span class="comment"></span>
<span class="comment">    The RKH uses a set of integer quantities. That maybe </span>
<span class="comment">    machine or compiler dependent.</span>
<span class="comment"></span>
<span class="comment">    Note:</span>
<span class="comment"></span>
<span class="comment">    The &#39;HUInt&#39; and &#39;HInt&#39; will normally be the natural size </span>
<span class="comment">    for a particular machine. These types designates an integer </span>
<span class="comment">    type that is usually fastest to operate with among all integer </span>
<span class="comment">    types.</span>
<span class="comment"> */</span>

<span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">char</span>     rkhi8_t;
<span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">short</span>    rkhi16_t;
<span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">long</span>     rkhi32_t;
<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   rkhui8_t;
<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  rkhui16_t;
<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   rkhui32_t;

<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    HUInt;
<span class="keyword">typedef</span> <span class="keywordtype">signed</span> <span class="keywordtype">int</span>      HInt;


<span class="preprocessor">#endif</span>
</pre></div> </div></div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 9 2012 13:05:36 for RKH by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
